version: '3.8'

services:
  # --- Reverse Proxy (Nginx) ---
  # Recibe todo el tr√°fico del puerto 80 y lo reparte
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - client-a-app
      - client-b-app
    restart: always

  # --- Cliente A ---
  client-a-redis:
    image: redis:alpine
    container_name: client-a-redis
    volumes:
      - client_a_redis_data:/data
    restart: always

  client-a-app:
    build: .
    container_name: client-a-app
    expose:
      - "3000" # Solo visible para Nginx, no desde internet directo
    environment:
      - PORT=3000
      - DATA_DIR=data
      - REDIS_URL=redis://client-a-redis:6379
      - NODE_ENV=production
    volumes:
      - client_a_data:/usr/src/app/data
    depends_on:
      - client-a-redis
    restart: always

  # --- Cliente B ---
  client-b-redis:
    image: redis:alpine
    container_name: client-b-redis
    volumes:
      - client_b_redis_data:/data
    restart: always

  client-b-app:
    build: .
    container_name: client-b-app
    expose:
      - "3000" # Solo visible para Nginx
    environment:
      - PORT=3000
      - DATA_DIR=data
      - REDIS_URL=redis://client-b-redis:6379
      - NODE_ENV=production
    volumes:
      - client_b_data:/usr/src/app/data
    depends_on:
      - client-b-redis
    restart: always

volumes:
  client_a_redis_data:
  client_a_data:
  client_b_redis_data:
  client_b_data: